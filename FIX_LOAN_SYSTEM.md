# คำแนะนำในการแก้ไขปัญหาระบบสินเชื่อ

## ปัญหาที่พบ
1. ยอดเงินกู้ไม่แสดงในหน้าธุรกรรมการเงิน
2. เมื่อทำการกู้เงิน ระบบแสดงเป็นเงินฝากแทนที่จะเป็นรับเงินกู้
3. ไม่มีการแยกธุรกรรมเงินกู้ออกจากธุรกรรมฝาก-ถอน

## การแก้ไข
เราจะแก้ไขระบบให้แสดงยอดเงินกู้อย่างถูกต้องและแยกธุรกรรมรับเงินกู้ออกจากเงินฝาก โดยมีขั้นตอนดังนี้:

### 1. อัปเดตโครงสร้างฐานข้อมูล

ไฟล์ SQL สำหรับอัปเดตโครงสร้างฐานข้อมูลอยู่ที่ `backend/migrations/fix_loan_transactions.sql`

#### วิธีการอัปเดตฐานข้อมูล:

1. เข้าสู่ MySQL ด้วยคำสั่ง:
```
mysql -u username -p
```

2. เลือกฐานข้อมูลที่ต้องการอัปเดต:
```
USE mooban;
```

3. นำเข้าไฟล์ SQL:
```
source /path/to/Mooban/backend/migrations/fix_loan_transactions.sql
```

หรือใช้ phpMyAdmin:
1. เข้าสู่ phpMyAdmin
2. เลือกฐานข้อมูลของคุณ
3. ไปที่แท็บ "SQL"
4. คัดลอกเนื้อหาจากไฟล์ `fix_loan_transactions.sql` และวางลงในช่อง
5. คลิก "Go" เพื่อรันคำสั่ง SQL

### 2. อัปเดตไฟล์ backend

1. แทนที่ไฟล์ `backend/routes/loans.js` ด้วยไฟล์ `backend/routes/loans.js.fix2`:
```
cp backend/routes/loans.js.fix2 backend/routes/loans.js
```

2. แทนที่ไฟล์ `backend/routes/transactions.js` ด้วยไฟล์ `backend/routes/transactions.js.fix2`:
```
cp backend/routes/transactions.js.fix2 backend/routes/transactions.js
```

### 3. อัปเดตไฟล์ frontend

1. แก้ไขไฟล์ `frontend/src/views/TransactionForm.vue` เพื่อแสดงยอดเงินกู้อย่างถูกต้องและแยกธุรกรรมรับเงินกู้ออกจากเงินฝาก:
   - เพิ่มแท็บสำหรับกรองประเภทธุรกรรม (ทั้งหมด, ฝาก-ถอน, สินเชื่อ)
   - แสดงยอดเงินกู้และยอดเงินฝากแยกกัน
   - แสดงผลการทำรายการที่แตกต่างกันสำหรับธุรกรรมเงินกู้และธุรกรรมฝาก-ถอน

### 4. ทดสอบระบบ

1. รีสตาร์ท backend server:
```
cd backend
npm run dev
```

2. รีสตาร์ท frontend server:
```
cd frontend
npm run serve
```

3. ทดสอบการทำธุรกรรมต่างๆ:
   - ทดสอบการเพิ่มข้อมูลสินเชื่อใหม่และตรวจสอบว่ายอดเงินกู้แสดงอย่างถูกต้อง
   - ทดสอบการชำระเงินกู้และตรวจสอบว่ายอดเงินกู้ลดลงอย่างถูกต้อง
   - ทดสอบการฝาก-ถอนเงินและตรวจสอบว่าไม่มีผลกระทบต่อยอดเงินกู้

## การเปลี่ยนแปลงที่สำคัญ

1. **เพิ่มคอลัมน์ loan_id ในตาราง transactions**:
   - เพื่อให้สามารถเชื่อมโยงธุรกรรมกับสินเชื่อได้โดยตรง

2. **แก้ไขข้อมูลในตาราง deposit_balance**:
   - คำนวณยอดเงินกู้ที่ถูกต้องจากธุรกรรมทั้งหมด
   - แก้ไขข้อมูลที่ไม่ถูกต้อง

3. **สร้างวิวสำหรับแสดงข้อมูล**:
   - `member_with_balance` - แสดงข้อมูลสมาชิกพร้อมยอดเงินฝากและยอดเงินกู้
   - `transactions_by_type` - แสดงข้อมูลธุรกรรมแยกตามประเภท

4. **ปรับปรุงหน้า TransactionForm.vue**:
   - เพิ่มแท็บสำหรับกรองประเภทธุรกรรม
   - แสดงยอดเงินกู้และยอดเงินฝากแยกกัน
   - แสดงผลการทำรายการที่แตกต่างกันสำหรับธุรกรรมเงินกู้และธุรกรรมฝาก-ถอน

## หมายเหตุ

การแก้ไขนี้จะช่วยให้ระบบสามารถแสดงยอดเงินกู้อย่างถูกต้องและแยกธุรกรรมรับเงินกู้ออกจากเงินฝาก ทำให้การแสดงผลข้อมูลทางการเงินของสมาชิกมีความถูกต้องมากขึ้น

หากมีปัญหาในการอัปเดต กรุณาติดต่อผู้ดูแลระบบ
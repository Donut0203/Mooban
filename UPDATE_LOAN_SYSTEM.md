# คำแนะนำในการอัปเดตระบบสินเชื่อ

## ปัญหาที่พบ
ปัจจุบันระบบมีปัญหาในการจัดการยอดเงินกู้และยอดเงินฝาก-ถอน โดยเมื่อมีการสร้างสินเชื่อใหม่ ระบบจะบันทึกข้อมูลลงในตาราง `deposit_balance` และสร้างธุรกรรมประเภท `loan_disbursement` ในตาราง `transactions` แต่ไม่ได้แยกการจัดการยอดเงินกู้ออกจากยอดเงินฝาก-ถอน

## การแก้ไข
เราจะแก้ไขระบบให้แยกการจัดการยอดเงินกู้ออกจากยอดเงินฝาก-ถอน โดยมีขั้นตอนดังนี้:

### 1. อัปเดตโครงสร้างฐานข้อมูล

ไฟล์ SQL สำหรับอัปเดตโครงสร้างฐานข้อมูลอยู่ที่ `backend/migrations/separate_loan_deposit_balance.sql`

#### วิธีการอัปเดตฐานข้อมูล:

1. เข้าสู่ MySQL ด้วยคำสั่ง:
```
mysql -u username -p
```

2. เลือกฐานข้อมูลที่ต้องการอัปเดต:
```
USE mooban;
```

3. นำเข้าไฟล์ SQL:
```
source /path/to/Mooban/backend/migrations/separate_loan_deposit_balance.sql
```

หรือใช้ phpMyAdmin:
1. เข้าสู่ phpMyAdmin
2. เลือกฐานข้อมูลของคุณ
3. ไปที่แท็บ "SQL"
4. คัดลอกเนื้อหาจากไฟล์ `separate_loan_deposit_balance.sql` และวางลงในช่อง
5. คลิก "Go" เพื่อรันคำสั่ง SQL

### 2. อัปเดตไฟล์ backend

1. แทนที่ไฟล์ `backend/routes/loans.js` ด้วยไฟล์ `backend/routes/loans.js.fix`:
```
cp backend/routes/loans.js.fix backend/routes/loans.js
```

2. แทนที่ไฟล์ `backend/routes/transactions.js` ด้วยไฟล์ `backend/routes/transactions.js.fix`:
```
cp backend/routes/transactions.js.fix backend/routes/transactions.js
```

### 3. อัปเดตไฟล์ frontend

แก้ไขไฟล์ `frontend/src/views/LoanForm.vue` โดยแทนที่ส่วนการส่งข้อมูลไปยัง backend ด้วยโค้ดจากไฟล์ `frontend/src/views/LoanForm.vue.fix`

### 4. ทดสอบระบบ

1. รีสตาร์ท backend server:
```
cd backend
npm run dev
```

2. รีสตาร์ท frontend server:
```
cd frontend
npm run serve
```

3. ทดสอบการเพิ่มข้อมูลสินเชื่อใหม่และตรวจสอบว่ายอดเงินกู้และยอดเงินฝาก-ถอนถูกแยกออกจากกันอย่างถูกต้อง

## การเปลี่ยนแปลงที่สำคัญ

1. **แยกการจัดการยอดเงินกู้ออกจากยอดเงินฝาก-ถอน**:
   - เมื่อสร้างสินเชื่อใหม่ ระบบจะเพิ่มยอดเงินกู้ในตาราง `deposit_balance` แต่ไม่เพิ่มยอดเงินฝาก
   - เมื่อชำระเงินกู้ ระบบจะลดยอดเงินกู้ในตาราง `deposit_balance` แต่ไม่ลดยอดเงินฝาก

2. **เพิ่มฟิลด์ loan_id ในตาราง transactions**:
   - เพื่อให้สามารถเชื่อมโยงธุรกรรมกับสินเชื่อได้โดยตรง

3. **สร้างวิวสำหรับแสดงข้อมูลสมาชิกพร้อมยอดเงินฝากและยอดเงินกู้**:
   - `member_with_balance` - แสดงข้อมูลสมาชิกพร้อมยอดเงินฝากและยอดเงินกู้

4. **สร้างวิวสำหรับแสดงข้อมูลธุรกรรมแยกตามประเภท**:
   - `transactions_by_type` - แสดงข้อมูลธุรกรรมแยกตามประเภท (deposit, loan, other)

## หมายเหตุ

การแก้ไขนี้จะช่วยให้ระบบสามารถแยกการจัดการยอดเงินกู้ออกจากยอดเงินฝาก-ถอนได้อย่างถูกต้อง ทำให้การแสดงผลข้อมูลทางการเงินของสมาชิกมีความถูกต้องมากขึ้น

หากมีปัญหาในการอัปเดต กรุณาติดต่อผู้ดูแลระบบ